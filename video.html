<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Best IPTV Player - Fixed</title>
    <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-body: #0a0a0a;
            --surface: #121212;
            --accent: #3b82f6;
            --text: #ffffff;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text);
            margin: 0;
            font-family: 'Roboto', sans-serif;
        }

        /* ১. ফিক্সড টপ সেকশন (লোগো, প্লেয়ার ও সার্চ) */
        .top-fixed-container {
            position: fixed;
            top: 0;
            width: 100%;
            background: var(--bg-body);
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .brand-header {
            background: white;
            padding: 10px 0;
            text-align: center;
        }

        .brand-header img { height: 50px; }

        /* প্লেয়ার সাইজ ফিক্সড */
        .video-js {
            width: 100% !important;
            aspect-ratio: 16/9;
        }

        /* ২. বাটন ও সার্চ বার */
        .nav-wrapper {
            background: #121212;
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .btn {
            background: #262626;
            color: #b3b3b3;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn.active { background: var(--accent); color: white; }

        .search-area {
            background: #121212;
            padding: 0 15px 10px;
        }

        .search-input {
            width: 100%;
            background: #262626;
            border: 1px solid #333;
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            outline: none;
        }

        /* ৩. চ্যানেল গ্রিড (স্ক্রলযোগ্য) */
        .main-content {
            margin-top: 410px; /* উপরের ফিক্সড অংশের হাইট অনুযায়ী অ্যাডজাস্ট করা */
            padding: 15px;
        }

        .channel-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px 10px;
        }

        .channel-item {
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .channel-item:active { transform: scale(0.9); }

        .logo-circle {
            width: 70px;
            height: 70px;
            background: #1a1a1a;
            border-radius: 50%;
            margin: 0 auto 8px;
            overflow: hidden;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .channel-name {
            font-size: 12px;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 5px;
        }

        /* মোবাইল অ্যাডজাস্টমেন্ট */
        @media (max-width: 400px) {
            .main-content { margin-top: 380px; }
            .logo-circle { width: 60px; height: 60px; }
        }
    </style>
</head>
<body>

    <div class="top-fixed-container">
        <div class="brand-header">
            <img src="https://i.ibb.co/vYm6zG0/best-iptv-logo.png" alt="Best IPTV">
        </div>

        <video id="iptv-player" class="video-js vjs-big-play-centered vjs-theme-city" controls preload="auto">
            <p class="vjs-no-js">To view this video please enable JavaScript.</p>
        </video>

        <div class="nav-wrapper">
            <button class="btn"><i class="fas fa-border-all"></i> All</button>
            <button class="btn"><i class="fas fa-list"></i> Categories</button>
            <button class="btn active"><i class="fas fa-heart"></i> Favorites</button>
        </div>

        <div class="search-area">
            <input type="text" id="channelSearch" class="search-input" placeholder="Search channels...">
        </div>
    </div>

    <div class="main-content">
        <div id="channelGrid" class="channel-grid">
            </div>
    </div>

    <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
    <script>
        const player = videojs('iptv-player');
        const grid = document.getElementById('channelGrid');
        const searchInput = document.getElementById('channelSearch');
        let allChannels = [];

        // ১. স্ট্রীম প্লে করার উন্নত ফাংশন
        function playStream(url, name) {
            player.src({
                src: url,
                type: (url.includes('.m3u8')) ? 'application/x-mpegURL' : 'video/mp4'
            });
            player.play();
            // মোবাইল ইউজারদের জন্য ওপরের দিকে স্ক্রল
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ২. M3U ফেচ এবং এরর হ্যান্ডলিং
        async function loadPlaylist() {
            const urlParams = new URLSearchParams(window.location.search);
            const playlistUrl = urlParams.get('playlist');
            
            if (!playlistUrl) {
                grid.innerHTML = '<p style="text-align:center; color:gray;">No Playlist URL Found.</p>';
                return;
            }

            try {
                const response = await fetch(playlistUrl);
                const data = await response.text();
                allChannels = parseM3U(data);
                renderChannels(allChannels);
            } catch (error) {
                console.error("Fetch Error:", error);
                grid.innerHTML = '<p style="text-align:center; color:red;">Error loading playlist.</p>';
            }
        }

        // ৩. M3U পার্সার (উন্নত)
        function parseM3U(content) {
            const lines = content.split('\n');
            const result = [];
            let current = null;

            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    const name = line.split(',').pop() || "Unknown";
                    const logo = line.match(/tvg-logo="([^"]*)"/)?.[1] || "";
                    current = { name, logo };
                } else if (line && !line.startsWith('#')) {
                    if (current) {
                        current.url = line;
                        result.push(current);
                        current = null;
                    }
                }
            });
            return result;
        }

        // ৪. রেন্ডার চ্যানেল
        function renderChannels(list) {
            grid.innerHTML = '';
            list.forEach(item => {
                const card = document.createElement('div');
                card.className = 'channel-item';
                card.innerHTML = `
                    <div class="logo-circle">
                        <img src="${item.logo}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/716/716429.png'">
                    </div>
                    <div class="channel-name">${item.name}</div>
                `;
                card.onclick = () => playStream(item.url, item.name);
                grid.appendChild(card);
            });
        }

        // ৫. রিয়েল-টাইম সার্চ
        searchInput.oninput = (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allChannels.filter(c => c.name.toLowerCase().includes(term));
            renderChannels(filtered);
        };

        // ৬. ভিডিও এরর রিকভারি
        player.on('error', function() {
            const error = player.error();
            console.log("VideoJS Error:", error);
            // সামান্য নেটওয়ার্ক সমস্যার কারণে এরর হলে রিলোড করার চেষ্টা
            if(error.code === 4) {
                setTimeout(() => player.load(), 2000);
            }
        });

        window.onload = loadPlaylist;
    </script>
</body>
</html>
